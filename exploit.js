var master_b = new Uint32Array(2);
var slave_b =  new Uint32Array(2);
var slave_addr;
var slave_buf_addr;
var master_addr;

// تنظیمات نسخه
const ps4_9_00 = 2;
let target = ps4_9_00;

// تابع نمایش پیام در سایت شما
function debug_log(msg) {
    var statusDisplay = document.getElementById("selected");
    if (statusDisplay) {
        statusDisplay.textContent = msg;
    }
    console.log("PS4Master Log: " + msg);
}

// توابع کمکی تبدیل اعداد و حافظه
function check_range(x) { return (-0x80000000 <= x) && (x <= 0xffffffff); }

class Int {
    constructor(low, high) {
        let buffer = new Uint32Array(2);
        let bytes = new Uint8Array(buffer.buffer);
        if (typeof low === 'number') {
            buffer[0] = low;
            buffer[1] = high || (low < 0 ? -1 : 0);
        } else if (typeof low === 'object') {
            bytes.set(low);
        }
        this.buffer = buffer; this.bytes = bytes;
    }
    low() { return this.buffer[0]; }
    high() { return this.buffer[1]; }
    add(b) {
        if (!(b instanceof Int)) b = new Int(b);
        let l = this.low() + b.low();
        let c = l > 0xffffffff ? 1 : 0;
        return new Int(l & 0xffffffff, (this.high() + b.high() + c) & 0xffffffff);
    }
    sub(b) {
        if (!(b instanceof Int)) b = new Int(b);
        let low = this.low() - b.low();
        let borrow = low < 0 ? 1 : 0;
        return new Int(low >>> 0, (this.high() - b.high() - borrow) >>> 0);
    }
}

// شبیه‌سازی توابع پایه برای جلوگیری از ارور لودینگ
function write64(view, offset, value) {
    let low = value.low(); let high = value.high();
    for (let i = 0; i < 4; i++) view[offset + i] = (low >>> i*8) & 0xff;
    for (let i = 0; i < 4; i++) view[offset + 4 + i] = (high >>> i*8) & 0xff;
}
function read64(view, offset) {
    let res = [];
    for (let i = 0; i < 8; i++) res.push(view[offset + i]);
    return new Int(res);
}

// تابع اصلی که با کلیک روی دکمه در index.html اجرا می‌شود
async function poc() {
    debug_log("Starting WebKit Exploit...");
    try {
        // در اینجا منطق اکسپلویت قرار می‌گیرد
        // چون دستگاه شما 9.00 نیست، این بخش در مرورگر کامپیوتر یا PS4 11.52
        // معمولاً متوقف می‌شود، اما دیگر ارور ساختاری نمی‌دهد.
        await sleep(1000);
        debug_log("Stage: Initializing...");
        // بقیه کدهای اصلی اکسپلویت در فایل‌های kexploit.js هستند
        if(typeof run_hax === 'function') {
            run_hax();
        } else {
            debug_log("Error: kexploit.js not loaded!");
        }
    } catch (e) {
        debug_log("Exploit Failed: " + e.message);
    }
}

function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

// حذف اجرای خودکار (فقط با فراخوانی poc() اجرا می‌شود)
console.log("PS4Master: Exploit Script Loaded Ready.");
